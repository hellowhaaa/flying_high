{% extends "layout.html" %} {% block homepage %}
<script
  src="https://code.jquery.com/jquery-2.1.1.min.js"
  type="text/javascript"
></script>
<link
  href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/css/select2.min.css"
  rel="stylesheet"
/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.1/js/select2.min.js"></script>
<script type="text/javascript">
  $(document).ready(function () {
    fetch("/fetch_user_depart_flight_code")
      .then((response) => response.json())
      .then((data) => {
        $("#depart_airlines").select2({
          data: Object.keys(data).map((key) => ({ id: key, text: key })),
        });

        $("#depart_airlines").on("change", function () {
          var selectedAirline = $(this).val();
          var flightCodes = data[selectedAirline] || [];
          $("#depart_flightCodes")
            .empty()
            .select2({
              data: flightCodes.map((code) => ({ id: code, text: code })),
            });
        });
      })
      .catch((error) =>
        console.error("Error fetching the airline data:", error)
      );
  });
</script>
<script type="text/javascript">
  $(document).ready(function () {
    fetch("/fetch_user_arrive_flight_code")
      .then((response) => response.json())
      .then((data) => {
        $("#arrive_airlines").select2({
          data: Object.keys(data).map((key) => ({ id: key, text: key })),
        });

        $("#arrive_airlines").on("change", function () {
          var selectedAirline = $(this).val();
          var flightCodes = data[selectedAirline] || [];
          $("#arrive_flightCodes")
            .empty()
            .select2({
              data: flightCodes.map((code) => ({ id: code, text: code })),
            });
        });
      })
      .catch((error) =>
        console.error("Error fetching the airline data:", error)
      );
  });
</script>
{% endblock %} {% block content %}
<style>
  .btn-custom {
    background-color: #f0f4ff9a;
    border: 1px solid #c7d2ff;
    border-radius: 8px;
    color: #4f6ea8;
    padding: 8px 16px;
    box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    transition: all 0.2s;
    font-weight: normal;
  }
  .btn-custom:hover {
    background-color: #d8e2ff;
    border-color: #b3c4ff;
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
  }
  .btn-cancel-soft {
    background-color: #e6e6e6b7;
    border: 1px solid #cccccc;
    border-radius: 8px;
    color: #333333;
    padding: 8px 16px;
    box-shadow: 0 3px 5px rgba(0, 0, 0, 0.1);
    text-transform: uppercase;
    transition: all 0.2s;
    font-weight: normal;
  }
  .btn-cancel-soft:hover {
    background-color: #d6d6d6;
    border-color: #b3b3b3;
    box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15);
  }
</style>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-2 bg-light sidebar py-5">
      <ul class="nav flex-column">
        <li class="nav-item">
          <a class="nav-link" href="info.html">我的資料</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="insurance.html">我的保險</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="notify.html">通知設定</a>
        </li>
        <li class="nav-item">
          <a class="nav-link active" href="flight.html">我的航班</a>
        </li>
      </ul>
    </div>
    <!-- Content -->
    <div class="col-md-10">
      <div class="py-4 px-md-5">
        <h1 class="mb-4">我的航班</h1>

        <!-- static info -->
        <div id="static-info" class="static-info">
          {% if user_info_dict%}
          <p class="mb-2">
            起飛班機日期：
            <span>{{ user_info_dict['depart_taiwan_date'] }}</span>
          </p>
          <p class="mb-2">
            起飛班機：
            <span>{{ user_info_dict['flight_depart_taoyuan'] }}</span>
          </p>
          <p class="mb-2">
            抵達班機日期：
            <span>{{ user_info_dict['arrive_taiwan_date'] }}</span>
          </p>
          <p class="mb-2">
            抵達班機：
            <span>{{ user_info_dict['flight_arrive_taoyuan'] }}</span>
          </p>
          {% else %}
          <h4>您尚未做設定</h4>
          {% endif %}
          <button class="btn btn-custom mt-3" onclick="toggleEdit(true)">
            編輯
          </button>
        </div>

        <!-- flight form -->
        <form id="flightForm" style="display: none">
          <div class="row mb-3">
            <div class="col-md-6">
              <label for="startDate" class="form-label">旅遊開始日期:</label>
              <input
                type="date"
                class="form-control"
                id="startDate"
                name="startDate"
              />
            </div>
            <div class="col-md-6">
              <label for="endDate" class="form-label">旅遊結束日期:</label>
              <input
                type="date"
                class="form-control"
                id="endDate"
                name="endDate"
              />
            </div>
          </div>

          <p>到達班機</p>
          <div class="input-group mb-3">
            <select
              class="form-select"
              id="arrive_airlines"
              name="arriveFlight"
            ></select>
          </div>
          <div class="form-group mb-3">
            <select
              class="form-control"
              id="arrive_flightCodes"
              style="width: 100%"
              name="arriveFlightNumber"
            ></select>
          </div>

          <p>起飛班機</p>
          <div class="input-group mb-3">
            <select
              class="form-select"
              id="depart_airlines"
              name="departFlight"
            ></select>
          </div>
          <div class="form-group mb-3">
            <select
              class="form-control"
              id="depart_flightCodes"
              style="width: 100%"
              name="departFlightNumber"
            ></select>
          </div>

          <button
            type="button"
            class="btn btn-cancel-soft"
            onclick="toggleEdit(false)"
          >
            取消
          </button>
          <button
            type="button"
            class="btn btn-custom"
            onclick="submitFlightInfo()"
          >
            儲存
          </button>
        </form>
      </div>
    </div>
  </div>
  <script>
    function toggleEdit(editMode) {
      const staticInfo = document.getElementById("static-info");
      const flightForm = document.getElementById("flightForm");

      if (editMode) {
        staticInfo.style.display = "none";
        flightForm.style.display = "block";
      } else {
        staticInfo.style.display = "block";
        flightForm.style.display = "none";
      }
    }

    function submitFlightInfo() {
      const formData = new FormData(document.getElementById("flightForm"));

      fetch("/user/update_flight_info", {
        method: "POST",
        body: formData,
        headers: {
          Accept: "application/json",
          "X-CSRFToken": document
            .querySelector('meta[name="csrf-token"]')
            .getAttribute("content"),
        },
      })
        .then((response) => response.json())
        .then((data) => {
          console.log("Success:", data);
          alert("Flight information saved successfully!");
          // Redirect to the desired URL
          if (data.status === "success" && data.redirect_url) {
            window.location.href = data.redirect_url;
          }

          // toggleEdit(false);
        })
        .catch((error) => {
          console.error("Error:", error);
          alert("Failed to save flight information.");
        });
    }
  </script>

  {% endblock %}
</div>
